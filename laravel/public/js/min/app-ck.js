var sidebarOpen,userSidebarOpen,initialListLeft,initialViewLeft,apiPlaces,map,markers=[],categories=[],setGeoData,editingItemView,$selectizeCountry,$mapCountrySelector,$modalCountrySelector,$selectizeCity,countryCities,$varselectize=[],sidebarAnimationWait=200;$(document).ready(function(){window.map=L.map("map",{zoomControl:!1}).setView([-34.622101,-58.377602],13),L.tileLayer("http://{s}.tiles.mapbox.com/v3/aerolab.map-oin5832f/{z}/{x}/{y}.png",{attribution:'<a href="https://www.mapbox.com/about/maps/">&copy; Mapbox &copy; OpenStreetMap</a>',maxZoom:17,minZoom:3}).addTo(map),map.addControl(L.control.zoom({position:"bottomright"})),getMarkers(),$("#toggle-nav").click(function(e){sidebarOpen?($(this).removeClass("active"),$("body").removeClass("sidebar-open"),sidebarOpen=!1,$("#sidebar .startupView").wait(450).remove(),$("#map .marker").removeClass("active"),map._size.x=$(window).width()):(userSidebarOpen&&rightSidebarClose(),$("body").addClass("sidebar-open"),$(this).addClass("active"),sidebarOpen=!0,map._size.x=$(window).width()-370),e.preventDefault()}),$('a[href="#list"]').click(function(e){$(this).addClass("active"),$('a[href="#thumbs"]').removeClass("active"),$(".styleThumb").removeClass("active"),e.preventDefault()}),$('a[href="#thumbs"]').click(function(e){$(this).addClass("active"),$('a[href="#list"]').removeClass("active"),$(".styleThumb").addClass("active"),e.preventDefault()}),$(".aboutUs").on("click",function(e){$("#about").addClass("open"),e.preventDefault()}),$("#about .close").click(function(e){$("#about").removeClass("open"),e.preventDefault()}),$(".panel").on("click","#list .itemsList li a",function(e){startupPanel($(this).attr("data-id")),e.preventDefault()}),$(".panel").on("click","#categories li a",function(e){e.preventDefault();var t=$(this).attr("data-id");if(console.log(t),"all"!=t)var a=findCategoryByID(t);else var a={slug:"all"};loadList(t),$("#sidebar .startupView").css("left",370).removeClass("active").wait(450).remove(),$("#categories li").removeClass("active"),$(this).parent().addClass("active"),categoriesHoverActive(),$('a[href="#thumbs"]').removeClass("active"),$('a[href="#list"]').addClass("active"),History.replaceState({},"StartupMap - Mapa de Startups Latinoamericanas","/"+window.env.country.slug+"/"+a.slug),ga("send","pageview","/"+a.slug)}),$(".panel").on("click",".startupView .close",function(e){$(this).parent().css("left",370).removeClass("active").wait(450).remove(),$("#map .marker").removeClass("active"),e.preventDefault()}),$("#list").hoverIntent(function(){initialViewLeft=100}),$(".panel").on("click",'a[href="#edit"]',function(e){return isLogged()?(openEditView($(this).data("id")),void e.preventDefault()):($("#login .msg").html("Identificate para editar una startup"),$('#userControl a[href="#userPanel"]').trigger("click"),!1)}),$('#userControl a[href="#userPanel"]').click(function(e){if(rightSidebarOpen(),$("#userSidebar .sidebarPanel").removeClass("open"),isLogged()){$("#userSidebar #profilePanel").addClass("open");var t=$("#profilePanelTemplate").html();Mustache.parse(t),$("#profilePanel").empty().html(Mustache.render(t,window.env.user))}else $("#userSidebar #login").addClass("open");e.preventDefault()}),$('#userControl a[href="#addStartup"]').click(function(e){return isLogged()?(rightSidebarOpen(),$("#userSidebar .sidebarPanel").removeClass("open"),$("#userSidebar #addStartup").addClass("open"),void e.preventDefault()):($("#login .msg").html("Identificate para agregar una startup"),$('#userControl a[href="#userPanel"]').trigger("click"),!1)}),$("#leftClose").click(function(e){$("#toggle-nav").wait(sidebarAnimationWait).removeClass("active"),$("body").removeClass("sidebar-open"),map._size.x=$(window).width(),sidebarOpen=!1,e.preventDefault()}),$("#rightClose").click(function(e){map._size.x=$(window).width(),rightSidebarClose(),e.preventDefault()}),$("#registerBtn").click(function(e){$("#userSidebar .sidebarPanel").removeClass("open"),$("#userSidebar #register").addClass("open"),e.preventDefault()}),$("#recoverBtn").click(function(e){$("#userSidebar .sidebarPanel").removeClass("open"),$("#userSidebar #recover").addClass("open"),e.preventDefault()}),$("#registerBackBtn, #recoverBackBtn").click(function(e){$("#userSidebar .sidebarPanel").removeClass("open"),$("#userSidebar #login").addClass("open"),e.preventDefault()}),$("#addStartup .toggle a").on("click",function(e){var t=$(this).attr("href").substring(1);$(this).toggleClass("active"),$(this).parent().parent().find(".i-"+t).slideToggle(),e.preventDefault()}),$(".location input").bind("keypress",function(e){geolocate()}),$(document).on("click",'[data-geomapbox="selected-address"]',function(){var e=$(this);setGeoData={lat:geoData.results[$(this).data("index")].geometry.location.lat,lng:geoData.results[$(this).data("index")].geometry.location.lng};var t=geoData.results[$(this).data("index")].address_components[2].short_name,a=$selectizeCity[0].selectize;a.addOption({city:t}),a.setValue(t),$(".address_options").empty();var r=[setGeoData.lat,setGeoData.lng];geolocateSetMarker(r),map.panTo([setGeoData.lat,setGeoData.lng]),map.setZoom(17)}),$("#uploadLogoArea").click(function(){$("#uploadLogo").click()}),$("#uploadBannerArea").click(function(){$("#uploadBanner").click()}),$selectizeCat=$("#startupCreateCategory").selectize(),$selectizeTag=$("#startupCreateTags").selectize({maxItems:4}),$selectizeCity=$("#startupCreateCity").selectize({create:!0,createOnBlur:!0,maxItems:1,valueField:"city",labelField:"city",searchField:["city"],onChange:geolocate});var t=$selectizeCity[0].selectize;t.clearOptions(),$.each(window.env.countryList[window.env.country.iso].cities,function(e,a){t.addOption({city:a.name})}),$selectizeCountry=$("#startupCreateCountry").selectize({onChange:function(){var e=$("#startupCreateCountry");changeMapCountry(e.val(),!0),geolocate();var t=$selectizeCity[0].selectize;t.clearOptions(),$.each(window.env.countryList[window.env.country.iso].cities,function(e,a){t.addOption({city:a.name})})},onInitialize:function(){}}),$selectizeCountry[0].selectize.setValue(window.env.country.iso),$(".panel").on("click","#startupClaim",function(e){$(".claimForm").slideToggle(),e.preventDefault()}),$(".success",$("#userSidebar")).click(function(){rightSidebarClose(),$(this).hide()});var a="error",r=".app",s="data-app-route",o=!0,n={request:function(e,t,a,r){$(".errorList").hide(),$(".control").removeClass("error"),"undefined"==typeof a&&(a="POST"),"undefined"==typeof t&&(t={}),$.ajax({url:window.env.endpoint+e,dataType:"json",data:t,type:a,async:!0,complete:function(e){return o&&console.log(e.responseJSON),"undefined"!=typeof e.responseJSON.redirect?void redirect(e.responseJSON.redirect):void("function"==typeof r&&r(e,e.responseJSON))}})},auth:{login:function(){n.request("login",{email:$("#appLoginEmail").val(),password:$("#appLoginPassword").val()},"POST",function(e,t){return 400==e.status?(i(t.errors,{email:"login-email",password:"login-password"}),!1):(window.env.user=t.user,addUserImg(),void $("#btnLogin").removeClass("processing"))})},logout:function(){n.request("logout",{},"GET",function(e,t){200==e.status&&(window.env.user=!1,$(".userPanel").removeClass("logged"),rightSidebarClose())})},linkedin:function(){n.request("login/linkedin",{},"GET",function(e){})}},user:{create:function(){return isLogged()?!1:void n.request("user",$("#registerForm").jsonIt(),"POST",function(e,t){return 400==e.status?(i(t.errors,{email:"register-email",password:"register-password",name:"register-name",last_name:"register-last_name"}),!1):($("#registerSuccess").show(),window.env.user=t.user,$("#btnRegister").removeClass("processing"),void ga("send","event","Nuevo Usuario","E-Mail"))})},recover:function(){return isLogged()?!1:void n.request("reset_password",$("#recoverForm").jsonIt(),"POST",function(e,t){400==e.status&&(i(t.errors,{email:"recover-email"}),$("#btnRecover").removeClass("processing")),$("#btnRecover").removeClass("processing"),$(".success",$("#userSidebar #recover")).show()})}},startup:{claim:function(){return isLogged()?void n.request("startup/"+$("#currentStartupView").val()+"/claim",{note:$("#claimNote").val()},"POST",function(e,t){if(400==e.status){return alert(t.error),!1;$("#btnClaim").removeClass("processing")}alert(t.message),$(".claimForm").hide(),$("#btnClaim").removeClass("processing")}):(alert("You have to be logged."),!1)},create:function(){return isLogged()?(n.request("startup",$("#startupCreate").jsonIt(),"POST",function(e,t){if(console.log(t),400==e.status)return i(t,{name:"startup-name",slogan:"startup-slogan",category:"startup-category",tags:"startup-tags",address:"startup-address",city:"startup-city",country:"startup-country",website:"startup-website",crunchbase:"startup-crunchbase",angelist:"startup-angellist",facebook:"startup-facebook",dribbble:"startup-dribbble",twitter:"startup-twitter",foursquare:"startup-foursquare",google_plus:"startup-googleplus",linkedin:"startup-linkedin",youtube:"startup-youtube",description:"startup-description",logo:"startup-logo",banner:"startup-banner"}),$("#btnStartupCreate").removeClass("processing"),$("#addStartup").scrollTop(0),!1;$("#btnStartupCreate").removeClass("processing"),$("#startupCreateSuccess").show(),$("input,select,textarea","#startupCreate").empty();var a=findCategoryByID($("#startupCreate").jsonIt().name);ga("send","event","Nueva Empresa",a),"object"==typeof newMarker&&(map.removeLayer(newMarker),newMarker=!1),getMarkers()}),!1):(alert("You have to be logged."),!1)},edit:function(){return isLogged()?(n.request("startup/"+$("#startupCreateID").val(),$("#startupCreate").jsonIt(),"PUT",function(e,t){return 400==e.status?(i(t,{name:"startup-name",slogan:"startup-slogan",category:"startup-category",tags:"startup-tags",address:"startup-address",city:"startup-city",country:"startup-country",website:"startup-website",crunchbase:"startup-crunchbase",angelist:"startup-angellist",facebook:"startup-facebook",dribbble:"startup-dribbble",twitter:"startup-twitter",foursquare:"startup-foursquare",google_plus:"startup-googleplus",linkedin:"startup-linkedin",youtube:"startup-youtube",description:"startup-description",logo:"startup-logo",banner:"startup-banner"}),$("#btnStartupEdit").removeClass("processing"),!1):($(".success","#addStartup").show(),$("#btnStartupEdit").removeClass("processing"),"object"==typeof newMarker&&(map.removeLayer(newMarker),newMarker=!1),void getMarkers())}),!1):(alert("You have to be logged."),!1)}}};$("#appWrapper").on("click",r,function(e){var t=$(this).attr(s).split("."),a=n;if($(this).addClass("processing"),0!=t.length){for(var r=0;r<=t.length-1;r++){var o=t[r];"undefined"!=typeof a&&(a=a[o])}a()}e.preventDefault()});var i=function(e,t){$.each(t,function(t,a){var r=0;"undefined"!=typeof e[t]&&($("input, textarea",".control[data-control="+a+"]").bind("focus",function(){$(".control[data-control="+a+"]").removeClass("error")}),$(".errorList",".control[data-control="+a+"]").empty(),$.each(e[t],function(e,t){$(".errorList",".control[data-control="+a+"]").append("<li>"+t+"</li>"),r++}),r>0&&$(".control[data-control="+a+"]").addClass("error"))})};$mapCountrySelector=$("#mapCountrySelector").selectize({render:{option:function(e,t){return'<div class="countryItem country'+t(e.value)+'"><i></i><span>'+t(e.text)+"</span></div>"},item:function(e,t){return'<div class="countryItem selected country'+t(e.value)+'"><i></i><span>'+t(e.text)+"</span></div>"}}}),$mapCountrySelector.on("change",function(e){var t=$("#mapCountrySelector");changeMapCountry(t.val())}),$(".ajaxFileUpload").each(function(){var t=$(this).attr("data-upload-route"),a=$("#"+$(this).attr("data-upload-field")),r=$("#"+$(this).attr("data-upload-input")),s=$(".dropzone",$(this)),o=$(this).fileupload({url:window.env.endpoint+t,fileInput:r,dropZone:s,dataType:"json",success:function(e,t){return"error"==e.status?(alert(e.error),!1):(a.empty().val(e.file.name),s.empty().css("background-image","url("+e.file.path+")"),s.css("background-size","cover"),!1)},fail:function(){return alert(e.error),!1}});o.bind("fileuploaddragover",function(e,t){s.addClass("drag-over"),setTimeout(function(){s.removeClass("drag-over")},4e3)}),o.bind("fileuploadsubmit",function(e,t){s.removeClass("drag-over"),s.addClass("uploading")}),o.bind("fileuploaddone",function(e,t){s.removeClass("drag-over, uploading")})}),isLogged()&&addUserImg(),"object"==typeof window.env.country&&"0"==window.env.startup&&changeMapCountry(window.env.country.iso);var l=$("#modalCountrySelector").selectize({render:{option:function(e,t){return'<div class="countryItem country'+t(e.value)+'"><i></i><span>'+t(e.text)+"</span></div>"},item:function(e,t){return'<div class="countryItem selected country'+t(e.value)+'"><i></i><span>'+t(e.text)+"</span></div>"}}});l.on("change",function(e){var t=$("#modalCountrySelector");changeMapCountry(t.val()),l[0].selectize.destroy(),$("#modalCountrySelect").remove()})});